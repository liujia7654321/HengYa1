# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'Page2.ui'
#
# Created by: PyQt5 UI code generator 5.15.2
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtGui, QtWidgets

from PyQt5 import QtCore
from PyQt5.QtWidgets import *
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.backends.backend_qt5agg import NavigationToolbar2QT as NavigationToolbar
from matplotlib.figure import Figure
import matplotlib.pyplot as plt
import numpy as np
from scipy import optimize


def f_1(x, A, B):
    return A * x + B

class MyMplCanvas(FigureCanvas):
    def __init__(self, parent=None, width=5, height=4, dpi=100):
        plt.rcParams['font.family'] = ['SimHei']
        plt.rcParams['axes.unicode_minus'] = False
        self.fig = Figure(figsize=(width, height), dpi=dpi)
        self.axes = self.fig.add_subplot(111)
        # self.axes.hold(False)
        FigureCanvas.__init__(self, self.fig)
        self.setParent(parent)
        FigureCanvas.setSizePolicy(
            self,
            QSizePolicy.Expanding,
            QSizePolicy.Expanding
        )
        FigureCanvas.updateGeometry(self)
        self.fig.suptitle('Δθ/Δq-q曲线图')
        self.axes.set_ylabel('Δθ/Δq(s/m)')
        self.axes.set_xlabel('q(m3/m2)')
        self.axes.grid(True)




    def start_static_plot(self):

        # 拟合点
        x0 = [75, 70, 65, 60, 55, 50, 45, 40, 35, 30]
        y0 = [22.44, 22.17, 21.74, 21.37, 20.92, 20.67, 20.32, 20.05, 19.84, 19.59]

        # 绘制散点
        self.axes.scatter(x0[:], y0[:], s = 10, c = "red",alpha=0.5)

        # 直线拟合与绘制
        A1, B1 = optimize.curve_fit(f_1, x0, y0)[0]
        x1 = np.arange(30, 75, 0.01)  # 30和75要对应x0的两个端点，0.01为步长
        y1 = A1 * x1 + B1
        self.axes.plot(x1, y1, "red",label='label1')
        self.axes.legend(loc='lower right', fontsize=12)  # 标签位置

        y2 = [75, 70, 65, 60, 55, 50, 45, 40, 35, 30]
        x2 = [22.44, 22.17, 21.74, 21.37, 20.92, 20.67, 20.32, 20.05, 19.84, 19.59]

        # 绘制散点
        self.axes.scatter(x2[:], y2[:], s=10, c="blue", alpha=0.5)

        # 直线拟合与绘制
        A2, B2 = optimize.curve_fit(f_1, x2, y2)[0]
        x3 = np.arange(30, 75, 0.01)  # 30和75要对应x0的两个端点，0.01为步长
        y3 = A2 * x3 + B2
        self.axes.plot(x3, y3, "blue", label='label2')
        self.axes.legend(loc='lower right', fontsize=12)  # 标签位置
        self.draw()

    # def start_dynamic_plot(self, *args, **kwargs):
        # timer = QtCore.QTimer(self)
        # timer.timeout.connect(self.update_figure)
        # timer.start(1000)

    def update_figure(self,x,y,name):
        x.reverse()
        y.reverse()
        if len(x) < 3:
            return
        # 直线拟合与绘制
        A1, B1 = optimize.curve_fit(f_1, x, y)[0]
        if A1 <= 0:
            return A1, B1
        # 绘制散点
        self.axes.scatter(x[:], y[:], s=10, alpha=0.5)
        x1 = np.arange(x[len(x)-1],x[0], 0.01)  # 对应x0的两个端点，0.01为步长
        y1 = A1 * x1 + B1
        fuhao = ''
        if B1 >= 0:
            fuhao = '+'
        lab = name+':'+'y='+str(round(A1, 1))+'*x' + fuhao +str(round(B1, 2))
        self.axes.plot(x1, y1, label = lab )
        self.axes.legend(loc='lower right', fontsize=12)  # 标签位置
        self.draw()
        return A1, B1


class MatplotlibWidget(QWidget):
    def __init__(self, parent=None):
        super(MatplotlibWidget, self).__init__(parent)
        self.layout = QVBoxLayout(self)
        self.mpl = MyMplCanvas(self, width=5, height=4, dpi=100)
        self.mpl_ntb = NavigationToolbar(self.mpl, self)
        self.layout.addWidget(self.mpl)
        self.layout.addWidget(self.mpl_ntb)
    def clear(self):
        self.mpl.close()
        self.mpl_ntb.close()
        del self.mpl
        del self.mpl_ntb
        self.mpl = MyMplCanvas(self, width=5, height=4, dpi=100)
        self.layout.addWidget(self.mpl)
        self.mpl_ntb = NavigationToolbar(self.mpl, self)
        self.layout.addWidget(self.mpl_ntb)

class Ui_Page2(object):
    global ui
    def setupUi(self, Page2):
        Page2.setObjectName("Page2")
        Page2.resize(1310, 744)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("Resource/icon/File Reco.ico"), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        Page2.setWindowIcon(icon)
        self.groupBox = QtWidgets.QGroupBox(Page2)
        self.groupBox.setGeometry(QtCore.QRect(340, 70, 961, 631))
        font = QtGui.QFont()
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.groupBox.setFont(font)
        self.groupBox.setObjectName("groupBox")
        self.frame_7 = QtWidgets.QFrame(Page2)
        self.frame_7.setGeometry(QtCore.QRect(0, 80, 341, 621))
        self.frame_7.setStyleSheet("")
        self.frame_7.setFrameShape(QtWidgets.QFrame.Box)
        self.frame_7.setFrameShadow(QtWidgets.QFrame.Raised)
        self.frame_7.setLineWidth(2)
        self.frame_7.setObjectName("frame_7")
        self.label_7 = QtWidgets.QLabel(self.frame_7)
        self.label_7.setGeometry(QtCore.QRect(20, 30, 121, 26))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.label_7.setFont(font)
        self.label_7.setObjectName("label_7")
        self.textEdit = QtWidgets.QTextEdit(self.frame_7)
        self.textEdit.setGeometry(QtCore.QRect(160, 20, 141, 41))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.textEdit.setFont(font)
        self.textEdit.setObjectName("textEdit")
        self.label_8 = QtWidgets.QLabel(self.frame_7)
        self.label_8.setGeometry(QtCore.QRect(20, 100, 121, 26))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.label_8.setFont(font)
        self.label_8.setObjectName("label_8")
        self.textEdit_2 = QtWidgets.QTextEdit(self.frame_7)
        self.textEdit_2.setGeometry(QtCore.QRect(160, 90, 141, 41))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.textEdit_2.setFont(font)
        self.textEdit_2.setObjectName("textEdit_2")
        self.label_14 = QtWidgets.QLabel(self.frame_7)
        self.label_14.setGeometry(QtCore.QRect(20, 170, 121, 26))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.label_14.setFont(font)
        self.label_14.setObjectName("label_14")
        self.textEdit_4 = QtWidgets.QTextEdit(self.frame_7)
        self.textEdit_4.setGeometry(QtCore.QRect(160, 160, 141, 41))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.textEdit_4.setFont(font)
        self.textEdit_4.setObjectName("textEdit_4")
        self.textEdit_7 = QtWidgets.QTextEdit(self.frame_7)
        self.textEdit_7.setGeometry(QtCore.QRect(160, 300, 141, 41))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.textEdit_7.setFont(font)
        self.textEdit_7.setObjectName("textEdit_7")
        self.label_21 = QtWidgets.QLabel(self.frame_7)
        self.label_21.setGeometry(QtCore.QRect(10, 310, 141, 26))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.label_21.setFont(font)
        self.label_21.setObjectName("label_21")
        self.textEdit_8 = QtWidgets.QTextEdit(self.frame_7)
        self.textEdit_8.setGeometry(QtCore.QRect(160, 230, 141, 41))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.textEdit_8.setFont(font)
        self.textEdit_8.setObjectName("textEdit_8")
        self.label_22 = QtWidgets.QLabel(self.frame_7)
        self.label_22.setGeometry(QtCore.QRect(20, 240, 121, 26))
        font = QtGui.QFont()
        font.setPointSize(14)
        self.label_22.setFont(font)
        self.label_22.setObjectName("label_22")
        self.pushButton_2 = QtWidgets.QPushButton(self.frame_7)
        self.pushButton_2.setGeometry(QtCore.QRect(90, 410, 121, 51))
        font = QtGui.QFont()
        font.setFamily("Arial")
        font.setPointSize(14)
        font.setBold(True)
        font.setItalic(False)
        font.setWeight(75)
        self.pushButton_2.setFont(font)
        self.pushButton_2.setStyleSheet(" QPushButton {\n"
"color: #333;\n"
"border: 2px solid #3465a4;\n"
"font:bold 14pt \"Arial\";\n"
"text-align:center;\n"
"border-radius: 8px;\n"
"padding: 5px;\n"
"background: qradialgradient(cx: 0.3, cy: -0.4,\n"
"fx: 0.3, fy: -0.4,\n"
"radius: 1.89, stop: 0 #fff, stop: 1 #888a85);\n"
"min-width: 80px;\n"
"}\n"
"\n"
"QPushButton:hover {\n"
"background: qradialgradient(cx: 0.3, cy: -0.4,\n"
"fx: 0.3, fy: -0.4,\n"
"radius: 1.89, stop: 0 #fff, stop: 1 #898a88);\n"
"}\n"
"\n"
" QPushButton:pressed {\n"
"background: qradialgradient(cx: 0.4, cy: -0.1,\n"
"fx: 0.4, fy: -0.1,\n"
"radius: 1.89, stop: 0 #fff, stop: 1 #8a8a89);\n"
"}")
        self.pushButton_2.setObjectName("pushButton_2")
        self.label_2 = QtWidgets.QLabel(Page2)
        self.label_2.setGeometry(QtCore.QRect(470, 10, 371, 71))
        font = QtGui.QFont()
        font.setPointSize(18)
        font.setUnderline(True)
        self.label_2.setFont(font)
        self.label_2.setObjectName("label_2")

        self.retranslateUi(Page2)
        QtCore.QMetaObject.connectSlotsByName(Page2)

    def retranslateUi(self, Page2):
        _translate = QtCore.QCoreApplication.translate
        Page2.setWindowTitle(_translate("Page2", "Δθ/Δq-q曲线图"))
        self.groupBox.setTitle(_translate("Page2", "Δθ/Δq-q曲线图"))
        self.label_7.setText(_translate("Page2", "曲线斜率："))
        self.label_8.setText(_translate("Page2", "曲线截距："))
        self.label_14.setText(_translate("Page2", "过滤常数K："))
        self.label_21.setText(_translate("Page2", "过滤常数τg："))
        self.label_22.setText(_translate("Page2", "过滤常数qe："))
        self.pushButton_2.setText(_translate("Page2", "清 空"))
        self.label_2.setText(_translate("Page2", "恒压过滤数据处理软件V1.0"))

    def init(self):
        # 清空
        self.pushButton_2.clicked.connect(self.clear)
        global ui
        # 显示至pyqt主界面
        ui = MatplotlibWidget()
        self.gridlayout = QGridLayout(self.groupBox)  # 继承容器groupBox
        self.gridlayout.addWidget(ui)

    def clear(self):
        self.textEdit.clear()
        self.textEdit_2.clear()
        self.textEdit_4.clear()
        self.textEdit_8.clear()
        self.textEdit_7.clear()
        global ui
        ui.clear()

    def AddLine(self,x,y,name):
        global ui
        # 曲线拟合，A1不可为0
        A1, B1 = ui.mpl.update_figure(x,y,name)
        self.textEdit.setText(str(round(A1, 1)))
        self.textEdit_2.setText(str(round(B1, 2)))
        print("A1=" + str(A1) + "A1不可为0，B1=" + str(B1))
        K = 2.0/A1
        print("K =" + str(K))
        self.textEdit_4.setText(str(round(K, 5)))
        qe = B1/A1
        self.textEdit_8.setText(str(round(qe, 8)))
        Qe = qe*qe/K
        self.textEdit_7.setText(str(round(Qe, 1)))
        return A1, B1, K, qe, Qe